<html>

<head>
	<title>Rag Browser Updater</title>
</head>

<body onload="countdown()">
	<!-- The title Bar -->
	<div id="title-bar">
		<h5 id="title">Rag Browser Updater</h5>
	</div>
	<button class="titleButtons" style="right: 45px; top: -8px; height: 28px;" onclick="minWindow()">-</button>
	<button class="titleButtons" style="right:25px; top: -9px; height: 19px;" onclick="maxWindow()">&squ;</button>
	<button class="titleButtons" style="right: 5px; top: -5px; height: 25px;" onclick="closeWindow()">&times;</button>
	<div id="card1">
		<h1>Are you sure you want to update?</h1>
		<h3>This procedure will erase all settings and bookmarks</h3>
		<br>
		<br>
		<br>
		<p>Rag Browser will update in <p id="counter">10s</p>
		</p>
		<br>
		<br>
		<br>
		<button style="border-color: red;" onclick="cancel()">Cancel</button><button style="border-color: green;" onclick="skip()">Continue</button>
	</div>
	<div id="card2" style="display: none;">
		<h1>Rag Browser is updating!</h1>
		<h3>Please don't close this window or turn off your computer</h3>
		<br>
		<br>
		<br>
		<h1 id="loading">&#x21bb;</h1>
		<br>
		<br>
		<div id="logDisplay"></div>
	</div>
	<style>
		#title-bar {
			-webkit-app-region: drag;
			background: #3f3f3f;
			color: white;
			height: 20px;
			padding: 0px;
			text-align: center;
			z-index: 99;
		}

		#title {
			margin: 0px;
			padding: 0px;
		}

		.titleButtons {
			position: fixed;
			font-weight: bolder;
			color: white;
			font-size: 24px;
			background: rgba(0, 0, 0, 0);
			border: none;
			padding-top: 0px;
			z-index: 100;
			-webkit-app-region: no-drag;
		}

		body {
			padding: 0px;
			margin: 0px;
			font-family: arial;
			text-align: center;
		}

		button {
			background: darkgrey;
			color: #555555;
			border: none;
			border-bottom-style: solid;
			border-width: 5px;
			margin: 5px;
			padding: 5px;
			font-size: 18;
			transition-duration: .2s;
		}

		button:hover {
			margin-top: 7px;
			border-width: 3px;
		}

		button:active {
			margin-top: 9px;
			border-width: 1px;
		}

		#loading {
			width: 100;
			margin: auto;
			-webkit-animation-name: spin;
			-webkit-animation-duration: 600ms;
			-webkit-animation-iteration-count: infinite;
			-webkit-animation-timing-function: linear;
			-moz-animation-name: spin;
			-moz-animation-duration: 600ms;
			-moz-animation-iteration-count: infinite;
			-moz-animation-timing-function: linear;
			-ms-animation-name: spin;
			-ms-animation-duration: 600ms;
			-ms-animation-iteration-count: infinite;
			-ms-animation-timing-function: linear;

			animation-name: spin;
			animation-duration: 600ms;
			animation-iteration-count: infinite;
			animation-timing-function: linear;
		}

		@-ms-keyframes spin {
			from {
				-ms-transform: rotate(0deg);
			}

			to {
				-ms-transform: rotate(360deg);
			}
		}

		@-moz-keyframes spin {
			from {
				-moz-transform: rotate(0deg);
			}

			to {
				-moz-transform: rotate(360deg);
			}
		}

		@-webkit-keyframes spin {
			from {
				-webkit-transform: rotate(0deg);
			}

			to {
				-webkit-transform: rotate(360deg);
			}
		}

		@keyframes spin {
			from {
				transform: rotate(0deg);
			}

			to {
				transform: rotate(360deg);
			}
		}

		#logDisplay {
			max-height: 250px;
			overflow: auto;
			text-align: left;
		}

	</style>
	<script>
		var seconds = 11;

		function countdown() {
			if (seconds > 1) {
				setTimeout(countdown, 1000);
			} else {
				document.getElementById('card1').style.display = "none";
				document.getElementById('card2').style.display = "block";
				update();
			}
			seconds--;
			document.getElementById('counter').innerHTML = seconds + "s";
		}

		function skip() {
			document.getElementById('card1').style.display = "none";
			document.getElementById('card2').style.display = "block";
			addToLog("Preparing To Update");
		}

		function cancel() {
			window.location.href = "index.html";
		}

		var BrowserWindow = require('electron').remote;
		var theWindow = BrowserWindow.getCurrentWindow();


		function closeWindow() {
			theWindow.close();
		}


		function maxWindow() {

			if (!theWindow.isMaximized()) {

				theWindow.maximize();

			} else {

				theWindow.unmaximize();

			}

		}


		function minWindow() {

			theWindow.minimize();

		}


		var dialog = require('electron').remote; // Load the dialogs component of the OS
		var fs = require('fs'); // Load the File System to execute our common tasks (CRUD)
		function deleteFile(filepath) {
			fs.exists(filepath, function(exists) {
				if (exists) {
					// File exists deletings
					fs.unlink(filepath, function(err) {
						if (err) {
							alert("An error ocurred updating the file" + err.message);
							addToLog(err);
							return;
						}
					});
				} else {
					addToLog("This file doesn't exist, cannot delete");
				}
			});
		}

		function update() {
			addToLog("Scanning and removing old Rag Browser files")
			fs.readdir(__dirname, (err, dir) => {
				for (var i = 0, path; path = dir[i]; i++) {
					if (path != "updater.html") {
						addToLog("Found " + path);
					} else {
						addToLog("Skipping " + path)
					}
				}
				addToLog("Downloading new files")
				download(file_url, DOWNLOAD_DIR);
				addToLog("Download complete")
			});

		}

		// Dependencies
		var http = require('https');
		var exec = require('child_process').exec;
		var spawn = require('child_process').spawn;

		// App variables
		var file_url = 'https://scanunicco.github.io/Rag%20Browser/Latest/Latest.zip';
		var DOWNLOAD_DIR = __dirname;

		function download(url, dest) {
			return new Promise((resolve, reject) => {
				const file = fs.createWriteStream(dest, {
					flags: "wx"
				});

				const request = http.get(url, response => {
					if (response.statusCode === 200) {
						response.pipe(file);
					} else {
						file.close();
						fs.unlink(dest, () => {}); // Delete temp file
						reject(`Server responded with ${response.statusCode}: ${response.statusMessage}`);
					}
				});

				request.on("error", err => {
					file.close();
					fs.unlink(dest, () => {}); // Delete temp file
					reject(err.message);
				});

				file.on("finish", () => {
					resolve();
				});

				file.on("error", err => {
					file.close();

					if (err.code === "EEXIST") {
						reject("File already exists");
					} else {
						fs.unlink(dest, () => {}); // Delete temp file
						reject(err.message);
					}
				});
			});
		}

		function addToLog(text) {
			document.getElementById('logDisplay').innerHTML = document.getElementById('logDisplay').innerHTML + "<br>" + text;
		}

	</script>
</body>

</html>
